using System.ComponentModel.DataAnnotations;
using System.Security.Claims;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using MalwareSampleExchange.Console.Database;
using MalwareSampleExchange.Console.Models;
using MalwareSampleExchange.Console.SampleStorage;

namespace MalwareSampleExchange.Console.Controllers;

/// <inheritdoc />
/// <summary>
/// </summary>
[Authorize]
public class UploadApiController : ControllerBase
{
    private readonly ILogger<UploadApiController> _logger;
    private readonly ISampleStorageHandler _sampleStorageHandler;
    private readonly ISampleMetadataHandler _sampleMetadataHandler;

    public UploadApiController(ILogger<UploadApiController> logger,
        ISampleStorageHandler sampleStorageHandler, ISampleMetadataHandler sampleMetadataHandler)
    {
        _logger = logger;
        _sampleStorageHandler = sampleStorageHandler;
        _sampleMetadataHandler = sampleMetadataHandler;
    }

    [HttpPut]
    [Route("/v1/sample")]
    public async Task<IActionResult> UploadSample([Required] IFormFile inputFile,
        [Required] string sha256, CancellationToken token = default)
    {
        try
        {
            var claimsIdentity = User.Identity as ClaimsIdentity;
            var role = claimsIdentity?.FindFirst(ClaimTypes.Role)?.Value ?? String.Empty;
            if (role != "Upload")
            {
                return Unauthorized();
            }
            await _sampleStorageHandler.WriteAsync(sha256, inputFile.OpenReadStream(), token);

            return Ok("Uploaded");
        }
        catch (Exception e)
        {
            _logger.LogError(LogEvents.InternalServerError, e, "Something went wrong.");
            return StatusCode(500, new Error
            {
                Code = 500,
                Message = "We encountered an error while processing the request."
            });
        }
    }

    [HttpPost]
    [Route("/v1/export-sample")]
    public async Task<IActionResult> UploadExportSampleData([Required] RequestExportSample sample, CancellationToken token = default)
    {
        try
        {
            var claimsIdentity = User.Identity as ClaimsIdentity;
            var role = claimsIdentity?.FindFirst(ClaimTypes.Role)?.Value ?? String.Empty;
            if (role != "Upload")
            {
                return Unauthorized();
            }
            await _sampleMetadataHandler.InsertSampleAsync(sample, token);

            return Ok("Uploaded");
        }
        catch (Exception e)
        {
            _logger.LogError(LogEvents.InternalServerError, e, "Something went wrong.");
            return StatusCode(500, new Error
            {
                Code = 500,
                Message = "We encountered an error while processing the request."
            });
        }
    }
}
