using System;
using System.Collections.Generic;
using System.IO;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using Amazon.S3;
using MalwareSampleExchange.Console.SampleStorage;
using Microsoft.Extensions.Logging;
using Microsoft.Extensions.Options;
using Moq;
using TestContainers.Container.Abstractions;
using TestContainers.Container.Abstractions.Hosting;
using Xunit;

namespace MalwareSampleExchange.Console_Test;

[Collection("S3SampleStorageHandlerTests")]
public class S3SampleStorageHandlerTests : IAsyncLifetime
{
    private readonly GenericContainer _minIoContainer;
    private readonly IOptions<S3StorageOptions> _defaultConfig;

    public S3SampleStorageHandlerTests()
    {
        var config = new S3StorageOptions
        {
            AccessKey = "AKIAIOSFODNN7EXAMPLE",
            SecretKey = "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
            Bucket = "results",
            S3Config = new AmazonS3Config
            {
                UseHttp = true,
                ForcePathStyle = true,
            }
        };

        _minIoContainer = new ContainerBuilder<GenericContainer>()
            .ConfigureDockerImageName("minio/minio:RELEASE.2020-06-01T17-28-03Z")
            //.ConfigureDockerImageName("quay.io/minio/minio:RELEASE.2022-02-01T18-00-14Z")
            .ConfigureContainer((h, c) =>
            {
                c.Env.Add("MINIO_ROOT_USER", config.AccessKey);
                c.Env.Add("MINIO_ROOT_PASSWORD", config.SecretKey);
                c.Env.Add("MINIO_ACCESS_KEY", config.AccessKey);
                c.Env.Add("MINIO_SECRET_KEY", config.SecretKey);
                //c.Env.Add("MINIO_HOST", "http://127.0.0.1:9000");
                //c.Env.Add("MINIO_SECURE", "false");
                c.Env.Add("MINIO_PROMETHEUS_AUTH_TYPE", "public");
                c.ExposedPorts.Add(9000);
                c.Command = new List<string> { "server", "/export" };
            })
            .Build();
        _defaultConfig = new OptionsWrapper<S3StorageOptions>(config);
    }

    [Fact]
    public async void Handler_RoundTrip()
    {
        var sha256 = "131f95c51cc819465fa1797f6ccacf9d494aaaff46fa3eac73ae63ffbdfd8267";
        var content = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*\n";
        var handler = new S3SampleStorageHandler(Mock.Of<ILogger<S3SampleStorageHandler>>(), _defaultConfig);

        await WriteFileWrapperAsync(handler, sha256, content);

        var size = await handler.GetFileSizeAsync(sha256);
        Assert.Equal(content.Length, size);

        var fileStreamResult = await handler.GetAsync(sha256);

        var reader = new StreamReader(fileStreamResult.FileStream);
        var text = await reader.ReadToEndAsync();
        Assert.Equal(content, text);
    }

    private async Task WriteFileWrapperAsync(ISampleStorageHandler handler, string sha256, string s)
    {
        var stream = new MemoryStream();
        var writer = new StreamWriter(stream);
        await writer.WriteAsync(s);
        await writer.FlushAsync();
        stream.Position = 0;
        await handler.WriteAsync(sha256, stream);
    }

    public async Task InitializeAsync()
    {
        await _minIoContainer.StartAsync();

        _defaultConfig.Value.S3Config.ServiceURL =
            $"http://{_minIoContainer.GetDockerHostIpAddress()}:{_minIoContainer.GetMappedPort(9000)}";


        var httpClient = new HttpClient();

        while (!await IsMinioReady(httpClient))
        {
            Thread.Sleep(100);
        }

        var client = new AmazonS3Client(
            _defaultConfig.Value.AccessKey,
            _defaultConfig.Value.SecretKey,
            new AmazonS3Config
            {
                UseHttp = true,
                ForcePathStyle = true,
                ServiceURL = _defaultConfig.Value.S3Config.ServiceURL,
            });
        await client.PutBucketAsync(_defaultConfig.Value.Bucket);
    }

    private async Task<bool> IsMinioReady(HttpClient httpClient)
    {
        try
        {
            var uri = new Uri(new Uri(_defaultConfig.Value.S3Config.ServiceURL),
                "/minio/health/ready");
            return (await httpClient.GetAsync(uri)).IsSuccessStatusCode;
        }
        catch (Exception)
        {
            return false;
        }
    }

    public Task DisposeAsync() => _minIoContainer.StopAsync();
}
