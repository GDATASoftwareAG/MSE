using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Security.Cryptography;
using System.Text;
using System.Net.Http;
using JWT.Builder;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using MalwareSampleExchange.Console.ListRequester;
using Xunit;
using JWT.Algorithms;
using Microsoft.Extensions.Options;
using MalwareSampleExchange.Console.Database;
using MalwareSampleExchange.Console.Partner;
using MalwareSampleExchange.Console.SampleStorage;
using Microsoft.Extensions.Hosting;
using NSubstitute;

namespace MalwareSampleExchange.Console_Test;

[Collection("DockerContainerCollection")]
public class SampleExchangeTest : IClassFixture<MongoDockerFixture>
{
    private readonly MongoDockerFixture _mongoDockerFixture;

    private static readonly IConfiguration Configuration = new ConfigurationBuilder()
        .SetBasePath(Directory.GetCurrentDirectory())
        .AddJsonFile("appsettings.json")
        .AddEnvironmentVariables()
        .Build();

    public SampleExchangeTest(MongoDockerFixture mongoDockerFixture)
    {
        _mongoDockerFixture = mongoDockerFixture;
    }

    private static PartnerProvider CreatePartnerProvider()
    {
        return new PartnerProvider(Substitute.For<ILogger<PartnerProvider>>(),
            new OptionsWrapper<PartnerProviderOptions>(new PartnerProviderOptions
            {
                FilePath = Configuration["Config:FilePath"]!
            }), Substitute.For<IHostApplicationLifetime>(), new HttpClient());
    }

    private static ISampleStorageHandler CreateSampleGetter()
    {
        var options = new FileStorageOptions();
        Configuration.GetSection("Storage").Bind(options);

        var sampleGetter = new FileSampleStorageHandler(Substitute.For<ILogger<FileSampleStorageHandler>>(),
            new OptionsWrapper<FileStorageOptions>(options));
        return sampleGetter;
    }

    private ListRequester CreateListRequester(ISampleMetadataHandler? sampleMetadataReader = null)
    {
        sampleMetadataReader ??= Substitute.For<ISampleMetadataHandler>();
        var options = new ListRequesterOptions();
        Configuration.GetSection("Token").Bind(options);
        return new ListRequester(new OptionsWrapper<ListRequesterOptions>(options),
            sampleMetadataReader,
            CreatePartnerProvider(), CreateSampleGetter());
    }

    private MongoMetadataHandler CreateMongoMetadataReader()
    {
        var options = new MongoMetadataOptions();
        Configuration.GetSection("MongoDb").Bind(options);
        options.ConnectionString = $"mongodb://{_mongoDockerFixture.Hostname}:{_mongoDockerFixture.Port}";
        return new MongoMetadataHandler(new OptionsWrapper<MongoMetadataOptions>(options));
    }

    private static string HexStringFromBytes(IEnumerable<byte> bytes)
    {
        var sb = new StringBuilder();
        foreach (var b in bytes)
        {
            var hex = b.ToString("x2");
            sb.Append(hex);
        }

        return sb.ToString();
    }

    [Fact]
    public void AreCredentialsOkay_PartnerDoesNotExist_ReturnsFalse()
    {
        var partnerProvider = CreatePartnerProvider();

        Assert.False(partnerProvider
            .AreCredentialsOkay("ThisPartnerDoesNotExist", "FalschesPasswort"));
    }

    [Fact]
    public void AreCredentialsOkay_PartnerDoesExistButWrongPassword_ReturnsFalse()
    {
        var partnerProvider = CreatePartnerProvider();

        Assert.False(partnerProvider
            .AreCredentialsOkay("netisee", "FalschesPasswort"));
    }

    [Fact]
    public void AreCredentialsOkay_CredentialsAreOk_ReturnsTrue()
    {
        var partnerProvider = CreatePartnerProvider();

        Assert.True(partnerProvider
            .AreCredentialsOkay("partner2", "test123"));
    }

    [Fact]
    public void IsPartnerDisabled_Disabled_ReturnsFalse()
    {
        var partnerProvider = CreatePartnerProvider();

        Assert.False(partnerProvider
            .AreCredentialsOkay("disabledPartner", "test123"));
    }

    [Fact]
    public async void BusinessLogicCallback_GetSampleToken_NoFamilyName()
    {
        string sha256String;
        var reader = CreateMongoMetadataReader();
        var sampleGetter = CreateSampleGetter();
        var listRequester = CreateListRequester(reader);

        var tokens = await listRequester
            .RequestList("partner2", DateTime.Now.AddDays(-7), null).ToListAsync();

        var deserializedToken = new JwtBuilder()
            .WithAlgorithm(new HMACSHA512Algorithm())
            .WithSecret(Configuration["Token:Secret"])
            .MustVerifySignature()
            .Decode<IDictionary<string, object>>(tokens[0]._Token);

        var sha256FromToken = deserializedToken["sha256"].ToString();
        var filesizeFromToken = long.Parse(deserializedToken["filesize"].ToString()!);

        using (var sha256 = SHA256.Create())
        {
            sha256String = HexStringFromBytes(await sha256
                .ComputeHashAsync((await sampleGetter.GetAsync(sha256FromToken!)).FileStream));
        }

        Assert.Single(tokens);
        Assert.False(deserializedToken.ContainsKey("familyname"));
        Assert.Equal("131f95c51cc819465fa1797f6ccacf9d494aaaff46fa3eac73ae63ffbdfd8267", sha256String);
        Assert.Equal(69, filesizeFromToken);
    }

    [Fact]
    public async void BusinessLogicCallback_GetSampleToken_HasFamilyName()
    {
        string sha256String;
        var jwtBuilder = new JwtBuilder()
            .WithAlgorithm(new HMACSHA512Algorithm())
            .WithSecret(Configuration["Token:Secret"])
            .MustVerifySignature();
        var reader = CreateMongoMetadataReader();
        var sampleGetter = CreateSampleGetter();
        var listRequester = CreateListRequester(reader);

        var tokens = await listRequester
            .RequestList("partnerWithFamilyName", DateTime.Now.AddDays(-7),
                null).ToListAsync();

        var deserializedToken = jwtBuilder.Decode<IDictionary<string, object>>(tokens[0]._Token);

        var sha256FromToken = deserializedToken["sha256"].ToString();
        var partnerFromToken = deserializedToken["partner"].ToString();

        var filesizeFromToken = long.Parse(deserializedToken["filesize"].ToString()!);

        using (var sha256 = SHA256.Create())
        {
            sha256String = HexStringFromBytes(await sha256
                .ComputeHashAsync((await sampleGetter.GetAsync(sha256FromToken!)).FileStream));
        }

        Assert.Single(tokens);
        Assert.True(deserializedToken.ContainsKey("familyname"));
        Assert.Equal("131f95c51cc819465fa1797f6ccacf9d494aaaff46fa3eac73ae63ffbdfd8267", sha256String);
        Assert.Equal(69, filesizeFromToken);
    }
}
